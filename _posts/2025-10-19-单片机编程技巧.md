---
layout:     post
title:      单片机编程技巧
subtitle:   奇技淫巧，皆入彀中
date:       2025-10-19
author:     yucailee
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - 软件技术
---

单片机编程，说简单也简单，说复杂也复杂。希望总结一些可复用的技巧。逐渐充实吧。

<!--  ![]({{site.baseurl}}/img/allegro-logo.png)   -->

#### 首则

制定自己的编程规范，按照规范行事，做到整齐、一致、便于阅读理解。

程序要架构清晰、层次分明，便于扩充。

#### 指示

单片机电路通常要布置两个指示灯。这两个指示灯，可这样定义它们的功能。灯一在程序运行中某处翻转，即闪烁表示程序在运行。程序运行迟滞，则闪烁慢。不闪烁则表示卡死。灯二指示通信，当接收到消息时翻转，如快速闪烁表示连续收到消息。如不闪烁，表示未收到消息。这样在外部观察，就能大致判断内部状况。

如果采用了 *rtos*，灯一的翻转应在日常 *task* 里实现。这个 *task* 负责日常信息收集汇总，相当于秘书处。如果没用 *rtos*，那就在大循环的结束处翻转。

单片机电路一般有通信口。通信口在空闲时间歇发出数据，主要是流水号，即一个序列数，它总是增加的。这样可以由此判断内部运行正常与否。这个功能可与上述灯一的翻转在同一处实现。

#### 通信协议 

单片机免不了要与其它设备通信，于是得制定通信协议。通信都是两方互发通信帧 *frame* 。所谓通信协议，主要是这个帧如何组成。
以下是我认为比较合适的帧定义。

| 目的方  | 发送方  | 帧长 | 命令字 | 子命令字 | 命令数据 | 校验字 |
|:--:|:--:|--|--|--|--|--|
| 收方编号 | 发方编号 | 字节数   | 要做什么  | 命令细分 | 数据、参数等，多字节    | 校验数据，一般用二字节 |

帧的前面几个段都是一字节。目的方在第一段，便于收方接收，不是发给自己的帧，直接丢弃，免得浪费时间。发送方可用来区分命令类别，不同的发送方来的帧，由不同的任务去处理。帧长便于安排存储和复制。

#### 程序远程更新

程序含 bust 和 appli 两个独立运行部分，二者配合可实现 appli 的更新。利用 SRAM 传递标志，编译必须预留 SRAM 此处空间。此标志指示
 bust 应该在初始即转到 appli，或是在 bust 里盘桓。所有转跳，不管 appli 转到 bust，或是 bust 转到 appli，都由 soft_reset 至 
 bust 来实现。上电 reset 总是先在 bust 里盘桓片刻，再准备转跳去 appli。
 
 appli 的代码地址，通过查看中断向量表得到。arm 的中断向量表格式，第一格是 stack 初始位置，第二格是 code 起点地址。转跳去 appli 前，
在 SRAM 里写标志 TOAPPLI +APPLIADDR，soft_reset 后于 bust 初始转跳至该地址，即运行 appli。

如果是在 appli 里启动程序更新，先在 SRAM 写标志 TOBUST -NEWCODE，soft_reset 后在 bust 中等待 newcode。 接收到 nescode，直接
烧写到目标处，最后附校验字。

bust 初始总要查看 SRAM 标志，可能是 无标志(上电reset)，标志 TOAPPLI +APPLIADDR(有正确的 appli)，标志 TOBUST -NEW

#### 待添加



#### 某图加




#### 再在做



